
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>棋法 Move Generation - YY Every Day</title>
  <meta name="author" content="Arek.Yao">
  <link rel="author" href="humans.txt">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  
    
  
  <meta name="description" content="棋法：基础走法 Move Generation: Simple Moves 三层嵌套循环 Three Nested Loops 走法的产生是通过三层嵌套循环完成的：
* 遍历所有的棋子
* 遍历棋子所有的方向
* 遍历该方向上的所有格子 对于爬行棋子（如兵，马，王）， &hellip;">
  
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://arekyao.github.io/micromax/basic_move.html">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="YY Every Day" type="application/atom+xml">
  <meta name="og:type" content="website" />
  <meta name="og:site_name" content="YY Every Day" />
  <meta name="og:title" content="棋法 Move Generation" />
  <meta name="og:description" content="棋法：基础走法 Move Generation: Simple Moves 三层嵌套循环 Three Nested Loops 走法的产生是通过三层嵌套循环完成的：
* 遍历所有的棋子
* 遍历棋子所有的方向
* 遍历该方向上的所有格子 对于爬行棋子（如兵，马，王）， &hellip;" />
  <meta name="og:url" content="http://arekyao.github.io/micromax/basic_move.html"/>
  <meta name="url" content="http://arekyao.github.io/micromax/basic_move.html">
  
  <meta name="distribution" content="global">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <a class="brand" href="/">YY Every Day</a>
    <ul class="nav">
      <li><a href="/">Home</a></li>
      <li><a href="/blog/archives">Archives</a></li>
    </ul>
    <ul class="nav" data-subscription="rss">
      <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
      
    </ul>
      
    <form class="navbar-form" action="http://google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:arekyao.github.io" />
        <input class="span2" type="text" name="q" results="0" placeholder="Search"/>
      </fieldset>
    </form>
      
    
  </div>
</div>
</nav>
<div class="wrapper_single">
  <div class="container">
    <article class="span8 offset2 article-format" role="article">
      <div role="div">
        
        <header>
          <h1 class="entry-title">棋法 Move Generation</h1>
          
        </header>
        
        <h3 id="move-generation-simple-moveshttphomehccnetnlhgmullermovgenhtml"><a href="http://home.hccnet.nl/h.g.muller/movgen.html">棋法：基础走法 Move Generation: Simple Moves</a></h3>

<h4 id="three-nested-loops">三层嵌套循环 Three Nested Loops</h4>

<p>走法的产生是通过三层嵌套循环完成的：<br />
* 遍历所有的棋子<br />
* 遍历棋子所有的方向<br />
* 遍历该方向上的所有格子  </p>

<p>对于爬行棋子（如兵，马，王），针对棋子的遍历循环通过在第一层循环之后就终止了，尽管兵（E.P.）和王（别忘了还有王车易位）有时也能在特定方向上，移动不止一步。<br />
对于任何棋子，内层的循环都会放弃，当已经走出棋盘或者走到某个阻挡的棋子。
当然也有阻挡的棋子不影响步法的合法性的。</p>

<p>在讨论一些繁琐细节的 micro-max 实现细节之前，我们先大概了解一下基础步法的产生代码：</p>

<p>Move generation is done by three nested loops:</p>

<ul>
  <li>over the pieces  </li>
  <li>over all directions for that piece  </li>
  <li>over all squares in that direction  </li>
</ul>

<p>For crawling pieces (PNK) the loop over squares is usually terminated after the first iteration, although Pawns and Kings (castling!) sometimes also make more than one step in a particular direction. For any piece this inner loop can be aborted because we run off the board or into an obstructing piece, although for obstructing enemy pieces the move might still be legal. Before discussing the nitty-gritty details of the implementation in micro-Max below, we give the general outline of the basic move generator:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">int</span> <span class="n">o</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">    <span class="o">-</span><span class="mi">16</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>           <span class="cm">/* downstream pawn    */</span>
</span><span class="line">    <span class="mi">16</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>         <span class="cm">/* upstream pawn      */</span>
</span><span class="line">    <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>          <span class="cm">/* rook           */</span>
</span><span class="line">    <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="o">-</span><span class="mi">17</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>    <span class="cm">/* king, queen and bishop */</span>
</span><span class="line">    <span class="mi">14</span><span class="p">,</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="o">-</span><span class="mi">31</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="o">-</span><span class="mi">33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>  <span class="cm">/* knight         */</span>
</span><span class="line">    <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">12</span>      <span class="cm">/* directory          */</span>
</span><span class="line">      <span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line"><span class="k">do</span><span class="p">{</span>                 <span class="cm">/* LOOP OVER PIECES                 */</span>
</span><span class="line">  <span class="n">u</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>             <span class="cm">/* contents of square                   */</span>
</span><span class="line">  <span class="k">if</span><span class="p">(</span><span class="n">u</span><span class="o">&amp;</span><span class="n">k</span><span class="p">)</span>               <span class="cm">/* only do something if it contains a piece of mine     */</span>
</span><span class="line">  <span class="p">{</span> <span class="n">p</span> <span class="o">=</span> <span class="n">u</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">;</span>                <span class="cm">/* extract piece type                   */</span>
</span><span class="line">    <span class="n">j</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">30</span><span class="p">];</span>            <span class="cm">/* look up first direction it moves in directory    */</span>
</span><span class="line">    <span class="k">while</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">o</span><span class="p">[</span><span class="o">++</span><span class="n">j</span><span class="p">])</span>         <span class="cm">/* LOOP OVER DIRECTIONS r taken from vector list    */</span>
</span><span class="line">    <span class="p">{</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>                <span class="cm">/* start ray at current piece location          */</span>
</span><span class="line">      <span class="k">do</span><span class="p">{</span>               <span class="cm">/* LOOP OVER SQUARES                    */</span>
</span><span class="line">        <span class="n">y</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span>             <span class="cm">/* add one step                     */</span>
</span><span class="line">        <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>          <span class="cm">/* terminate ray if off board               */</span>
</span><span class="line">        <span class="n">t</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">y</span><span class="p">];</span>           <span class="cm">/* contents of target square                */</span>
</span><span class="line">        <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="n">k</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>          <span class="cm">/* terminate ray if own piece               */</span>
</span><span class="line">    <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&amp;&amp;!</span><span class="p">(</span><span class="n">r</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">)</span><span class="o">!=!</span><span class="n">t</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* terminate if pawn and inappropiate mode      */</span>
</span><span class="line">        <span class="p">....</span>                <span class="cm">/* valid move available: u@x -&gt; t@y. Use it!        */</span>
</span><span class="line">    <span class="n">t</span> <span class="o">+=</span> <span class="n">p</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span>           <span class="cm">/* make sure t!=0 for crawling pieces           */</span>
</span><span class="line">      <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span>            <span class="cm">/* ray continues if move was not capture        */</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">9</span><span class="o">&amp;~</span><span class="n">M</span><span class="p">);</span>           <span class="cm">/* next square of board                 */</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="the-loop-over-pieces">遍历棋子的循环 The Loop over Pieces</h4>

<p>在 micro-Max 中，对于棋子的遍历，在实现上，是通过遍历棋盘上所有棋子，找到对应白方或者黑方的棋子。<br />
这里效率上有点低，特别是在尾盘，棋盘越来越空的情况下。<br />
甚至是在开局，也仅仅只有25%的棋子在棋盘上。  </p>

<p>但是棋盘数组是一个比较直接的方法去找到我们想找到的以及如何走的（这个问题在每次试图走一个棋子，都需要回答的），但是这也导致我们不知道我们的棋子在什么地方。<br />
『因为会由棋子挂掉，当然也是因为要节约代码。这里也可以通过棋子列表等方式来实现。但是这里也不是性能的瓶颈，还需要额外维护一个数组结构，代码那是成倍的增加』</p>

<p>当然一个『棋子列表』，一个表格存储每个活着的棋子的棋盘编号和棋子类型，这样来玩是更合适的。『啊，你也知道啊』<br />
这样做，在最外层的棋子遍历上，可以很简单地扫描这个『棋子列表』就O了，每次都能找到1个活棋，而不是在一个大大的棋盘上，偶然发现一个棋子。  </p>

<p>但是由于性能最好的目标，我们决定牺牲掉这个『棋子列表』。<br />
这可是两害，取其轻呢！<br />
因为牺牲掉棋盘数组将是灾难性的，因为每次尝试性的移动，都需要去看这个移动是否被双方的棋子已经阻挡了。<br />
并且试图移动的个数比试图移动的棋子数多得多。<br />
原因稍后会变得更明显，棋盘扫描也可以不开始在一个角落里，而可以从任意位置开始，如变量B，可以环绕遍历棋盘，然后直到再次达到起点格。</p>

<p>In micro-Max the loop over pieces is implemented as a loop over all valid squares of the board, searching for pieces of the side to move. This is rather inefficient, especially if the board gets more empty during the game. Even in the beginning only on 25% of the squares it finds own pieces. The board array is a direct way of finding out what we find where we go, (a question that has to be answered frequently once we try to move a piece), but it leaves us unfortunately unaware of where our pieces are. For that a ‘piece list’, a table listing the square number and piece type for each piece we (still) have, would be better suited. The outer loop of the move generator would then simply scan this piece list, and find a piece every time, rather than only occasionally finding a piece on a board square. Because of the minimalist approach we decided to sacrifice the piece list. This is the best of two evils: sacrificing the board array would be completely disastrous, because for every attempted move the program could only find out if the move was to an occupied square by scanning the piece lists of both sides. And there are many more attempted moves than there are pieces to move. 
For reasons that will become apparent later, the board scan does not begin in a corner, but can begin anywhere on the board, as indicated by variable B. It then wraps around until it reaches that starting square again.</p>

<h4 id="the-loop-over-directions">The Loop over Directions</h4>

<p>If the scan of the board discovers a friendly piece, we start generating moves for this piece. To this end we loop through a list of move vectors, one for every direction a piece of that type can move in. An initialized global array o[] contains the move vectors r (numbers that have to be added to the current square to make one step in that direction). This list is scanned by the loop index j until a 0 is encountered (which obviously is an invalid move vector, since it would make no step at all). The move-vector lists for all piece types are all placed in the same array, one after the other, separated by zeroes. Lists are combined where possible: in the list for a Queen (which is also used for the King) the straight directions all preceed the diagonal directions, so that the final part of the list can be used for a Bishop, by starting it in the middle. For each piece type we need to know where to start scanning the o[] array, this information is stored further in the o[] array itself, so that a piece of type p finds its starting direction index j at o[p+30]. We could say that o[] summarizes most of the rules for chess.</p>

<p>To save some characters in the initializer for the list, we make use of the fact that allowed directions usually come in pairs of opposite directions. The list contains then only contains the positive one, and in the loop over directions each step vector is tried with both signs. Unless the piece is a Pawn, of course. This explains the obfuscated expression p&gt;2&amp;r&lt;0?-r:-o[++j] for the next direction r: first the negative version is tried, and the second time such a negative value is negated and used again.</p>

<h4 id="the-loop-over-squares">The Loop over Squares</h4>

<p>Once a move vector r is selected, the inner loop of the move generator repeatedly adds this to the location of the piece, to sweep the destination square y over the board along a ray. Each new y is tested for being on the board (y&amp;M==0), and if it is, the piece t on the destination square (t=b[y]) is checked. If it is one of our own or if we fall off the board, we break out of the loop immediately. If the piece belongs to the opponent, the move is a capture, and in general valid. So in that case we finish that iteration of the loop, but the test at the end of this do-while loop only continues looping if there was no capture (t==0, written compactly as !t).</p>

<p>For crawling pieces the loop has to terminate after the first iteration irrespective of the fact if the last move was a capture or not. To this end we fake a capture for those pieces (p&lt;5) at the end of the loop, by incrementing t. We still have to deal with the complication that some of the moves generated for pawns are forbidden. In particular straight pawn moves can’t be captures, and diagonal moves can’t be non-captures. We therefore break out of the loop at the beginning if we detect that the emptyness of the target sqaure (quantified by the expression !t) matches the straightness of the move vector (quantified as the expression !(r&amp;7), i.e. if the least significant bits of the move vector, the file displacement, equals zero or not).</p>

<p>Below the basic move-generator code is highlighted:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
<span class="line-number">133</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="cm">/***************************************************************************/</span>
</span><span class="line"><span class="cm">/*                               micro-Max,                                */</span>
</span><span class="line"><span class="cm">/* A chess program smaller than 2KB (of non-blank source), by H.G. Muller  */</span>
</span><span class="line"><span class="cm">/***************************************************************************/</span>
</span><span class="line"><span class="cm">/* version 3.2 (2000 characters) features:                                 */</span>
</span><span class="line"><span class="cm">/* - recursive negamax search                                              */</span>
</span><span class="line"><span class="cm">/* - quiescence search with recaptures                                     */</span>
</span><span class="line"><span class="cm">/* - recapture extensions                                                  */</span>
</span><span class="line"><span class="cm">/* - (internal) iterative deepening                                        */</span>
</span><span class="line"><span class="cm">/* - best-move-first &#39;sorting&#39;                                             */</span>
</span><span class="line"><span class="cm">/* - a hash table storing score and best move                              */</span>
</span><span class="line"><span class="cm">/* - full FIDE rules (expt minor ptomotion) and move-legality checking     */</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define F(I,S,N) for(I=S;I&lt;N;I++)</span>
</span><span class="line"><span class="cp">#define W(A) while(A)</span>
</span><span class="line"><span class="cp">#define K(A,B) *(int*)(T+A+(B&amp;8)+S*(B&amp;7))</span>
</span><span class="line"><span class="cp">#define J(A) K(y+A,b[y])-K(x+A,u)-K(H+A,t)</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define U 16777224</span>
</span><span class="line"><span class="k">struct</span> <span class="n">_</span> <span class="p">{</span><span class="kt">int</span> <span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="p">;</span><span class="kt">char</span> <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">D</span><span class="p">;}</span> <span class="n">A</span><span class="p">[</span><span class="n">U</span><span class="p">];</span>           <span class="cm">/* hash table, 16M+8 entries*/</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">V</span><span class="o">=</span><span class="mi">112</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mi">136</span><span class="p">,</span><span class="n">S</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">I</span><span class="o">=</span><span class="mf">8e3</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="mi">799</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>       <span class="cm">/* V=0x70=rank mask, M=0x88 */</span>
</span><span class="line">
</span><span class="line"><span class="kt">char</span> <span class="n">O</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">L</span><span class="p">,</span>
</span><span class="line"><span class="n">w</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">9</span><span class="p">},</span>                        <span class="cm">/* relative piece values    */</span>
</span><span class="line"><span class="n">o</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="o">-</span><span class="mi">17</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/* step-vector lists */</span>
</span><span class="line">     <span class="mi">7</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span>                          <span class="cm">/* 1st dir. in o[] per piece*/</span>
</span><span class="line">     <span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">},</span>                         <span class="cm">/* initial piece setup      */</span>
</span><span class="line"><span class="n">b</span><span class="p">[</span><span class="mi">129</span><span class="p">],</span>                                        <span class="cm">/* board: half of 16x8+dummy*/</span>
</span><span class="line"><span class="n">T</span><span class="p">[</span><span class="mi">1035</span><span class="p">],</span>                                       <span class="cm">/* hash translation table   */</span>
</span><span class="line">
</span><span class="line"><span class="n">n</span><span class="p">[]</span><span class="o">=</span><span class="s">&quot;.?+nkbrq?*?NKBRQ&quot;</span><span class="p">;</span>                        <span class="cm">/* piece symbols on printout*/</span>
</span><span class="line">
</span><span class="line"><span class="n">D</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>    <span class="cm">/* recursive minimax search, k=moving side, n=depth*/</span>
</span><span class="line"><span class="kt">int</span> <span class="n">k</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>  <span class="cm">/* (q,l)=window, e=current eval. score, E=e.p. sqr.*/</span>
</span><span class="line"><span class="p">{</span>                       <span class="cm">/* e=score, z=prev.dest; J,Z=hashkeys; return score*/</span>
</span><span class="line"> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">G</span><span class="p">;</span>
</span><span class="line"> <span class="kt">char</span> <span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">B</span><span class="p">;</span>
</span><span class="line"> <span class="k">struct</span> <span class="n">_</span><span class="o">*</span><span class="n">a</span><span class="o">=</span><span class="n">A</span><span class="p">;</span>
</span><span class="line">                                               <span class="cm">/* lookup pos. in hash table*/</span>
</span><span class="line"> <span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">E</span><span class="o">^</span><span class="n">J</span><span class="p">)</span><span class="o">&amp;</span><span class="n">U</span><span class="o">-</span><span class="mi">9</span><span class="p">;</span>                                <span class="cm">/* try 8 consec. locations  */</span>
</span><span class="line"> <span class="n">W</span><span class="p">((</span><span class="n">h</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="o">++</span><span class="n">j</span><span class="p">].</span><span class="n">K</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">h</span><span class="o">-</span><span class="n">Z</span><span class="o">&amp;&amp;--</span><span class="n">i</span><span class="p">);</span>                    <span class="cm">/* first empty or match     */</span>
</span><span class="line"> <span class="n">a</span><span class="o">+=</span><span class="n">i</span><span class="o">?</span><span class="n">j</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>                                     <span class="cm">/* dummy A[0] if miss &amp; full*/</span>
</span><span class="line"> <span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">K</span><span class="p">)</span>                                      <span class="cm">/* hit: pos. is in hash tab */</span>
</span><span class="line"> <span class="p">{</span><span class="n">d</span><span class="o">=</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">D</span><span class="p">;</span><span class="n">v</span><span class="o">=</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">V</span><span class="p">;</span><span class="n">X</span><span class="o">=</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">X</span><span class="p">;</span>                        <span class="cm">/* examine stored data      */</span>
</span><span class="line">  <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="o">&gt;=</span><span class="n">n</span><span class="p">)</span>                                     <span class="cm">/* if depth sufficient:     */</span>
</span><span class="line">  <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">v</span><span class="o">&gt;=</span><span class="n">l</span><span class="o">|</span><span class="n">X</span><span class="o">&amp;</span><span class="n">S</span><span class="o">&amp;&amp;</span><span class="n">v</span><span class="o">&lt;=</span><span class="n">q</span><span class="o">|</span><span class="n">X</span><span class="o">&amp;</span><span class="mi">8</span><span class="p">)</span><span class="k">return</span> <span class="n">v</span><span class="p">;</span>             <span class="cm">/* use if window compatible */</span>
</span><span class="line">   <span class="n">d</span><span class="o">=</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>                                      <span class="cm">/* or use as iter. start    */</span>
</span><span class="line">  <span class="p">}</span><span class="n">X</span><span class="o">&amp;=~</span><span class="n">M</span><span class="p">;</span><span class="n">Y</span><span class="o">=</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Y</span><span class="p">;</span>                               <span class="cm">/*      with best-move hint */</span>
</span><span class="line">  <span class="n">Y</span><span class="o">=</span><span class="n">d</span><span class="o">?</span><span class="n">Y</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>                                     <span class="cm">/* don&#39;t try best at d=0    */</span>
</span><span class="line"> <span class="p">}</span><span class="k">else</span> <span class="n">d</span><span class="o">=</span><span class="n">X</span><span class="o">=</span><span class="n">Y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>                                <span class="cm">/* start iter., no best yet */</span>
</span><span class="line"> <span class="n">N</span><span class="o">++</span><span class="p">;</span>                                          <span class="cm">/* node count (for timing)  */</span>
</span><span class="line"> <span class="n">W</span><span class="p">(</span><span class="n">d</span><span class="o">++&lt;</span><span class="n">n</span><span class="o">|</span><span class="n">z</span><span class="o">==</span><span class="mi">8</span><span class="o">&amp;</span><span class="n">N</span><span class="o">&lt;</span><span class="mf">1e7</span><span class="o">&amp;</span><span class="n">d</span><span class="o">&lt;</span><span class="mi">98</span><span class="p">)</span>                      <span class="cm">/* iterative deepening loop */</span>
</span><span class="line"> <span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="n">B</span><span class="o">=</span><span class="n">X</span><span class="p">;</span>                                       <span class="cm">/* start scan at prev. best */</span>
</span><span class="line">  <span class="n">Y</span><span class="o">|=</span><span class="mi">8</span><span class="o">&amp;</span><span class="n">Y</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">;</span>                                   <span class="cm">/* request try noncastl. 1st*/</span>
</span><span class="line">  <span class="n">m</span><span class="o">=</span><span class="n">d</span><span class="o">&gt;</span><span class="mi">1</span><span class="o">?-</span><span class="n">I</span><span class="o">:</span><span class="n">e</span><span class="p">;</span>                                  <span class="cm">/* unconsidered:static eval */</span>
</span><span class="line">  <span class="k">do</span><span class="p">{</span><span class="n">u</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>                                   <span class="cm">/* scan board looking for   */</span>
</span><span class="line">   <span class="k">if</span><span class="p">(</span><span class="n">u</span><span class="o">&amp;</span><span class="n">k</span><span class="p">)</span>                                     <span class="cm">/*  own piece (inefficient!)*/</span>
</span><span class="line">   <span class="p">{</span><span class="n">r</span><span class="o">=</span><span class="n">p</span><span class="o">=</span><span class="n">u</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">;</span>                                   <span class="cm">/* p = piece type (set r&gt;0) */</span>
</span><span class="line">    <span class="n">j</span><span class="o">=</span><span class="n">o</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">16</span><span class="p">];</span>                                 <span class="cm">/* first step vector f.piece*/</span>
</span><span class="line">    <span class="k">while</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">p</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">r</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">?-</span><span class="n">r</span><span class="o">:-</span><span class="n">o</span><span class="p">[</span><span class="o">++</span><span class="n">j</span><span class="p">])</span>                <span class="cm">/* loop over directions o[] */</span>
</span><span class="line">    <span class="p">{</span><span class="n">A</span><span class="o">:</span>                                        <span class="cm">/* resume normal after best */</span>
</span><span class="line">     <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="p">;</span><span class="n">F</span><span class="o">=</span><span class="n">G</span><span class="o">=</span><span class="n">S</span><span class="p">;</span>                                <span class="cm">/* (x,y)=move, (F,G)=castl.R*/</span>
</span><span class="line">     <span class="k">do</span><span class="p">{</span><span class="n">H</span><span class="o">=</span><span class="n">y</span><span class="o">+=</span><span class="n">r</span><span class="p">;</span>                                <span class="cm">/* y traverses ray          */</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&amp;</span><span class="mi">8</span><span class="p">)</span><span class="n">H</span><span class="o">=</span><span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="o">&amp;~</span><span class="n">M</span><span class="p">;</span>                         <span class="cm">/* sneak in prev. best move */</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">&amp;</span><span class="n">M</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>                            <span class="cm">/* board edge hit           */</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&amp;</span><span class="n">y</span><span class="o">==</span><span class="n">E</span><span class="p">)</span><span class="n">H</span><span class="o">=</span><span class="n">y</span><span class="o">^</span><span class="mi">16</span><span class="p">;</span>                      <span class="cm">/* shift capt.sqr. H if e.p.*/</span>
</span><span class="line">      <span class="n">t</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">H</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="n">k</span><span class="o">|</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&amp;!</span><span class="p">(</span><span class="n">r</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">)</span><span class="o">!=!</span><span class="n">t</span><span class="p">)</span><span class="k">break</span><span class="p">;</span>      <span class="cm">/* capt. own, bad pawn mode */</span>
</span><span class="line">      <span class="n">i</span><span class="o">=</span><span class="mi">99</span><span class="o">*</span><span class="n">w</span><span class="p">[</span><span class="n">t</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">];</span>                             <span class="cm">/* value of capt. piece t   */</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">||</span><span class="n">E</span><span class="o">-</span><span class="n">S</span><span class="o">&amp;&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">E</span><span class="p">]</span><span class="o">&amp;&amp;</span><span class="n">y</span><span class="o">-</span><span class="n">E</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">E</span><span class="o">-</span><span class="n">y</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span><span class="n">m</span><span class="o">=</span><span class="n">I</span><span class="p">;</span>      <span class="cm">/* K capt. or bad castling  */</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="o">&gt;=</span><span class="n">l</span><span class="p">)</span><span class="k">goto</span> <span class="n">C</span><span class="p">;</span>                          <span class="cm">/* abort on fail high       */</span>
</span><span class="line">
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="n">d</span><span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">!=</span><span class="n">z</span><span class="p">))</span>                           <span class="cm">/* remaining depth(-recapt.)*/</span>
</span><span class="line">      <span class="p">{</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">6</span><span class="o">?</span><span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="n">b</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>                  <span class="cm">/* center positional pts.   */</span>
</span><span class="line">       <span class="n">b</span><span class="p">[</span><span class="n">G</span><span class="p">]</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">H</span><span class="p">]</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">b</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">=</span><span class="n">u</span><span class="o">&amp;</span><span class="mi">31</span><span class="p">;</span>             <span class="cm">/* do move, strip virgin-bit*/</span>
</span><span class="line">       <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">G</span><span class="o">&amp;</span><span class="n">M</span><span class="p">)){</span><span class="n">b</span><span class="p">[</span><span class="n">F</span><span class="p">]</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">6</span><span class="p">;</span><span class="n">v</span><span class="o">+=</span><span class="mi">30</span><span class="p">;}</span>             <span class="cm">/* castling: put R &amp; score  */</span>
</span><span class="line">       <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">)</span>                                 <span class="cm">/* pawns:                   */</span>
</span><span class="line">       <span class="p">{</span><span class="n">v</span><span class="o">-=</span><span class="mi">9</span><span class="o">*</span><span class="p">(((</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="n">M</span><span class="o">||</span><span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="n">u</span><span class="p">)</span><span class="o">+</span>            <span class="cm">/* structure, undefended    */</span>
</span><span class="line">              <span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="n">M</span><span class="o">||</span><span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">!=</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>         <span class="cm">/*        squares plus bias */</span>
</span><span class="line">        <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">S</span><span class="p">){</span><span class="n">b</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">|=</span><span class="mi">7</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="n">C</span><span class="p">;}</span>             <span class="cm">/* promote p to Q, add score*/</span>
</span><span class="line">       <span class="p">}</span>
</span><span class="line">       <span class="n">v</span><span class="o">=-</span><span class="n">D</span><span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">k</span><span class="p">,</span><span class="o">-</span><span class="n">l</span><span class="o">-</span><span class="p">(</span><span class="n">l</span><span class="o">&gt;</span><span class="n">e</span><span class="p">),</span><span class="n">m</span><span class="o">&gt;</span><span class="n">q</span><span class="o">?-</span><span class="n">m</span><span class="o">:-</span><span class="n">q</span><span class="p">,</span><span class="o">-</span><span class="n">e</span><span class="o">-</span><span class="n">v</span><span class="o">-</span><span class="n">i</span><span class="p">,</span>    <span class="cm">/* recursive eval. of reply */</span>
</span><span class="line">            <span class="n">J</span><span class="o">+</span><span class="n">J</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">Z</span><span class="o">+</span><span class="n">J</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">G</span><span class="o">-</span><span class="n">S</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">h</span><span class="p">);</span>          <span class="cm">/* J,Z: hash keys           */</span>
</span><span class="line">       <span class="n">v</span><span class="o">-=</span><span class="n">v</span><span class="o">&gt;</span><span class="n">e</span><span class="p">;</span>                                 <span class="cm">/* delayed-gain penalty     */</span>
</span><span class="line">       <span class="k">if</span><span class="p">(</span><span class="n">z</span><span class="o">==</span><span class="mi">9</span><span class="p">)</span>                                <span class="cm">/* called as move-legality  */</span>
</span><span class="line">       <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">v</span><span class="o">!=-</span><span class="n">I</span><span class="o">&amp;</span><span class="n">x</span><span class="o">==</span><span class="n">K</span><span class="o">&amp;</span><span class="n">y</span><span class="o">==</span><span class="n">L</span><span class="p">)</span>                    <span class="cm">/*   checker: if move found */</span>
</span><span class="line">        <span class="p">{</span><span class="n">Q</span><span class="o">=-</span><span class="n">e</span><span class="o">-</span><span class="n">i</span><span class="p">;</span><span class="n">O</span><span class="o">=</span><span class="n">F</span><span class="p">;</span><span class="k">return</span> <span class="n">l</span><span class="p">;}</span>                 <span class="cm">/*   &amp; not in check, signal */</span>
</span><span class="line">        <span class="n">v</span><span class="o">=</span><span class="n">m</span><span class="p">;</span>                                   <span class="cm">/* (prevent fail-lows on    */</span>
</span><span class="line">       <span class="p">}</span>                                       <span class="cm">/*   K-capt. replies)       */</span>
</span><span class="line">       <span class="n">b</span><span class="p">[</span><span class="n">G</span><span class="p">]</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">38</span><span class="p">;</span><span class="n">b</span><span class="p">[</span><span class="n">F</span><span class="p">]</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="n">u</span><span class="p">;</span><span class="n">b</span><span class="p">[</span><span class="n">H</span><span class="p">]</span><span class="o">=</span><span class="n">t</span><span class="p">;</span>    <span class="cm">/* undo move,G can be dummy */</span>
</span><span class="line">       <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&amp;</span><span class="mi">8</span><span class="p">){</span><span class="n">m</span><span class="o">=</span><span class="n">v</span><span class="p">;</span><span class="n">Y</span><span class="o">&amp;=~</span><span class="mi">8</span><span class="p">;</span><span class="k">goto</span> <span class="n">A</span><span class="p">;}</span>              <span class="cm">/* best=1st done,redo normal*/</span>
</span><span class="line">       <span class="k">if</span><span class="p">(</span><span class="n">v</span><span class="o">&gt;</span><span class="n">m</span><span class="p">){</span><span class="n">m</span><span class="o">=</span><span class="n">v</span><span class="p">;</span><span class="n">X</span><span class="o">=</span><span class="n">x</span><span class="p">;</span><span class="n">Y</span><span class="o">=</span><span class="n">y</span><span class="o">|</span><span class="n">S</span><span class="o">&amp;</span><span class="n">G</span><span class="p">;}</span>               <span class="cm">/* update max, mark with S  */</span>
</span><span class="line">      <span class="p">}</span>                                        <span class="cm">/*          if non castling */</span>
</span><span class="line">      <span class="n">t</span><span class="o">+=</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span>                                  <span class="cm">/* fake capt. for nonsliding*/</span>
</span><span class="line">      <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&amp;</span><span class="mi">6</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">&amp;</span><span class="n">V</span><span class="p">)</span><span class="o">==</span><span class="n">S</span>                      <span class="cm">/* pawn on 3rd/6th, or      */</span>
</span><span class="line">          <span class="o">||</span><span class="p">(</span><span class="n">u</span><span class="o">&amp;~</span><span class="mi">24</span><span class="p">)</span><span class="o">==</span><span class="mi">36</span><span class="o">&amp;</span><span class="n">j</span><span class="o">==</span><span class="mi">7</span><span class="o">&amp;&amp;</span>                 <span class="cm">/* virgin K moving sideways,*/</span>
</span><span class="line">          <span class="n">G</span><span class="o">&amp;</span><span class="n">M</span><span class="o">&amp;&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">G</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">|</span><span class="mi">7</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">)]</span><span class="o">&amp;</span><span class="mi">32</span>          <span class="cm">/* 1st, virgin R in corner G*/</span>
</span><span class="line">          <span class="o">&amp;&amp;!</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">G</span><span class="o">^</span><span class="mi">1</span><span class="p">]</span><span class="o">|</span><span class="n">b</span><span class="p">[</span><span class="n">G</span><span class="o">^</span><span class="mi">2</span><span class="p">])</span>                   <span class="cm">/* 2 empty sqrs. next to R  */</span>
</span><span class="line">      <span class="p">){</span><span class="n">F</span><span class="o">=</span><span class="n">y</span><span class="p">;</span><span class="n">t</span><span class="o">--</span><span class="p">;}</span>                              <span class="cm">/* unfake capt., enable e.p.*/</span>
</span><span class="line">     <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">);</span>                               <span class="cm">/* if not capt. continue ray*/</span>
</span><span class="line">  <span class="p">}}}</span><span class="k">while</span><span class="p">((</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="mi">9</span><span class="o">&amp;~</span><span class="n">M</span><span class="p">)</span><span class="o">-</span><span class="n">B</span><span class="p">);</span>                      <span class="cm">/* next sqr. of board, wrap */</span>
</span><span class="line"><span class="nl">C:</span><span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="o">&gt;</span><span class="n">I</span><span class="o">/</span><span class="mi">4</span><span class="o">|</span><span class="n">m</span><span class="o">&lt;-</span><span class="n">I</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="n">d</span><span class="o">=</span><span class="mi">99</span><span class="p">;</span>                        <span class="cm">/* mate is indep. of depth  */</span>
</span><span class="line">  <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="o">+</span><span class="n">I</span><span class="o">?</span><span class="n">m</span><span class="o">:-</span><span class="n">D</span><span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">k</span><span class="p">,</span><span class="o">-</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>         <span class="cm">/* best loses K: (stale)mate*/</span>
</span><span class="line">  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">K</span><span class="o">|</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">&amp;</span><span class="n">M</span><span class="p">)</span><span class="o">!=</span><span class="n">M</span><span class="o">|</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">D</span><span class="o">&lt;=</span><span class="n">d</span><span class="p">)</span>                <span class="cm">/* if new/better type/depth:*/</span>
</span><span class="line">  <span class="p">{</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">K</span><span class="o">=</span><span class="n">Z</span><span class="p">;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">V</span><span class="o">=</span><span class="n">m</span><span class="p">;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">D</span><span class="o">=</span><span class="n">d</span><span class="p">;</span><span class="n">A</span><span class="o">-&gt;</span><span class="n">K</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>                <span class="cm">/* store in hash,dummy stays*/</span>
</span><span class="line">   <span class="n">a</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">|</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">&gt;</span><span class="n">q</span><span class="p">)</span><span class="o">|</span><span class="n">S</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">&lt;</span><span class="n">l</span><span class="p">);</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">;</span>              <span class="cm">/* empty, type (limit/exact)*/</span>
</span><span class="line">  <span class="p">}</span>                                            <span class="cm">/*    encoded in X S,8 bits */</span>
</span><span class="line"><span class="cm">/*if(z==8)printf(&quot;%2d ply, %9d searched, %6d by (%2x,%2x)\n&quot;,d-1,N,m,X,Y&amp;0x77);*/</span>
</span><span class="line"> <span class="p">}</span>
</span><span class="line"> <span class="k">if</span><span class="p">(</span><span class="n">z</span><span class="o">&amp;</span><span class="mi">8</span><span class="p">){</span><span class="n">K</span><span class="o">=</span><span class="n">X</span><span class="p">;</span><span class="n">L</span><span class="o">=</span><span class="n">Y</span><span class="o">&amp;~</span><span class="n">M</span><span class="p">;}</span>
</span><span class="line"> <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">main</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line"> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="n">c</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
</span><span class="line">
</span><span class="line"> <span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</span><span class="line"> <span class="p">{</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">V</span><span class="p">]</span><span class="o">=</span><span class="n">o</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">24</span><span class="p">]</span><span class="o">+</span><span class="mi">40</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">;</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span><span class="o">=</span><span class="mi">18</span><span class="p">;</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">96</span><span class="p">]</span><span class="o">=</span><span class="mi">9</span><span class="p">;</span>   <span class="cm">/* initial board setup*/</span>
</span><span class="line">  <span class="n">F</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="n">b</span><span class="p">[</span><span class="mi">16</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mf">3.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mf">3.5</span><span class="p">);</span>   <span class="cm">/* center-pts table   */</span>
</span><span class="line"> <span class="p">}</span>                                                   <span class="cm">/*(in unused half b[])*/</span>
</span><span class="line"> <span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="mi">1035</span><span class="p">)</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">random</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                                                <span class="cm">/* play loop          */</span>
</span><span class="line"> <span class="p">{</span><span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">121</span><span class="p">)</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; %c&quot;</span><span class="p">,</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">8</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">i</span><span class="o">+=</span><span class="mi">7</span><span class="p">)</span><span class="o">?</span><span class="mi">10</span><span class="o">:</span><span class="n">n</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">]);</span> <span class="cm">/* print board        */</span>
</span><span class="line">  <span class="n">p</span><span class="o">=</span><span class="n">c</span><span class="p">;</span><span class="n">W</span><span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="o">++=</span><span class="n">getchar</span><span class="p">())</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">);</span>                        <span class="cm">/* read input line    */</span>
</span><span class="line">  <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class="line">  <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="mi">10</span><span class="p">){</span><span class="n">K</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">16</span><span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">C</span><span class="p">;</span><span class="n">L</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">16</span><span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">C</span><span class="p">;}</span><span class="k">else</span>  <span class="cm">/* parse entered move */</span>
</span><span class="line">   <span class="n">D</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="o">-</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>                            <span class="cm">/* or think up one    */</span>
</span><span class="line">  <span class="n">F</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">U</span><span class="p">)</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">K</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>                                  <span class="cm">/* clear hash table   */</span>
</span><span class="line">  <span class="k">if</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="o">-</span><span class="n">I</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="n">I</span><span class="p">)</span><span class="n">k</span><span class="o">^=</span><span class="mi">24</span><span class="p">;</span>                 <span class="cm">/* check legality &amp; do*/</span>
</span><span class="line"> <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


        
      </div>
    
    </article>
  </div>
</div>
<div id="footer-widgets">
  <div class="container">
    <div class="row">
  <div class="span3">
    <h2>recent posts</h2>
    <ul class="recent_posts">
      
        <li>
          <a href="/blog/2013/10/02/workflow-engine-in-python/">Workflow Engine in Python</a>
        </li>
      
        <li>
          <a href="/blog/2013/07/02/the-key-technologies-in-simple-xiangqi-engine-maxqi/">The Key Technologies in Simple XiangQi Engine MaxQi</a>
        </li>
      
        <li>
          <a href="/blog/2013/06/23/something-about-chess-series-with-ai/">Something about Chess series with AI</a>
        </li>
      
        <li>
          <a href="/blog/2013/04/23/database-overview/">Database Overview</a>
        </li>
      
        <li>
          <a href="/blog/2013/04/21/something-interesting-about-ai/">Something Interesting about AI</a>
        </li>
      
    </ul>
    <h2><a href="/blog/archives">archives</a></h2>
  </div>
  <div class="span3">
    

  </div>
  <div class="span4">
    

  </div>
  <div class="span2">
    <h2>found on</h2>














  </div>
</div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-left">
  <a href="/">YY Every Day</a>
  - Copyright &copy; 2013 - Arek.Yao
</p>
<p class="pull-right">
  <span>Powered by <a href="http://octopress.org/">Octopress</a>.</span>
  
    <span>Designed by <a href="http://www.AdrianArtiles.com">Adrian Artiles</a>.</span>
  
</p>

  </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script>window.jQuery || document.write('<script src="/javascripts/libs/jquery-1.7.2.min.js" type="text/javascript"><\/script>')</script>
<script src="/javascripts/libs/bootstrap.min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.tweet.js" type="text/javascript"></script>
<script src="/javascripts/jquery.instagram.js" type="text/javascript"></script>
<script src="/javascripts/libs/jquery.masonry.min.js" type="text/javascript"></script>
<script src="/javascripts/custom.js" type="text/javascript"></script>


<script type="text/javascript">
      var disqus_shortname = 'arekyao';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




